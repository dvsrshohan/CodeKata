<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Time <span class="time"></span></h1>
    <p><span class="typing"></span></p>

    <div class="table">
      <table>
        <tbody></tbody>
      </table>
    </div>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>
  </body>
</html>

<script type="module">
  import { faker } from "https://cdn.skypack.dev/@faker-js/faker";

  const socket = new io();
  console.log();
  socket.on("greeting", console.log);
  socket.on("hello", console.log);
  socket.on("bye", console.log);

  socket.on("message", (data) => {
    appendMessage(data);
  });

  socket.on("time", (data) => {
    const time = data.time;
    document.querySelector(".time").innerHTML = time;
  });

  socket.on("typing-start", (message) => {
    document.querySelector(".typing").innerHTML = "typing... : " + message;
  });
  socket.on("typing-stop", (data) => {
    document.querySelector(".typing").innerHTML = "";
  });

  const form = document.querySelector("form");
  const input = document.querySelector("input");
  const tableBody = document.querySelector("table tbody");
  const tableContainer = document.querySelector(".table");

  input.value = faker.lorem.words(5);

  let keyPressingTimeout = null;

  input.addEventListener("keypress", ({ target: { value } }) => {
    clearTimeout(keyPressingTimeout);
    socket.emit("typing-start", value);
  });

  input.addEventListener("keyup", () => {
    clearTimeout(keyPressingTimeout);
    keyPressingTimeout = setTimeout(() => {
      socket.emit("typing-stop");
    }, 2000);
  });

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    socket.emit("message", input.value);
    appendMessage(input.value);
    input.value = faker.lorem.words(5);
  });

  function appendMessage(message) {
    const row = tableBody.insertRow();
    row.innerHTML = message;
    tableContainer.scrollTo(0, tableContainer.scrollHeight);
  }
</script>

<style>
  body {
    height: 90vh;
    display: flex;
    flex-direction: column;
    border: 1px solid tomato;
  }

  input {
    width: 50%;
  }

  .table {
    height: 80vh;
    overflow-x: scroll;
  }
</style>
